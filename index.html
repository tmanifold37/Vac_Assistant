<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VAC Policy Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg: #0f172a;
      --card: #020617;
      --panel: #061322;
      --bubble: #0b1220;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --border2: #374151;
      --link: #38bdf8;
    }
    *{ box-sizing:border-box; }

    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--text);
      display:flex;
      justify-content:center;
    }

    .container{
      max-width: 920px;
      width:100%;
      padding: 1.5rem;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: 1rem;
      padding: 1.6rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    }

    /* HERO */
    .hero{ margin-bottom: 1rem; }
    .title{
      margin:0;
      font-size: 2.05rem;
      line-height: 1.15;
      letter-spacing: -0.02em;
    }
    .subtitle{
      margin-top: 0.55rem;
      margin-bottom: 0.85rem;
      font-size: 0.98rem;
      line-height: 1.45;
      color: var(--muted);
      max-width: 68ch;
    }

    /* About toggle */
    .about-toggle{
      display:inline-flex;
      align-items:center;
      gap:0.45rem;
      border:1px solid var(--border2);
      background:var(--bubble);
      color:var(--text);
      padding:0.45rem 0.85rem;
      border-radius:999px;
      cursor:pointer;
      font-size:0.9rem;
      font-weight:700;
    }
    .about-toggle:hover{ border-color: var(--link); }
    .chev{ opacity:0.9; transform: translateY(-1px); }

    .about-panel{
      margin-top:0.75rem;
      padding:0.9rem;
      border:1px solid var(--border);
      border-radius:0.9rem;
      background:var(--panel);
    }
    .about-grid{
      display:grid;
      grid-template-columns: 1fr; /* vertical */
      gap:0.75rem;
    }
    .about-box{
      border:1px solid var(--border);
      border-radius:0.75rem;
      padding:0.8rem;
      background:var(--card);
    }
    .about-h{
      font-weight:800;
      margin-bottom:0.35rem;
      font-size:0.95rem;
    }
    .about-list{
      margin:0;
      padding-left:1.1rem;
      color:#d1d5db;
      line-height:1.5;
      font-size:0.92rem;
    }
    .about-note{
      margin-top:0.7rem;
      color:var(--muted);
      font-size:0.9rem;
      line-height:1.4;
    }

    /* Profile card */
    .profile-card{
      margin: 1rem 0 1rem;
      border:1px solid var(--border);
      border-radius:0.9rem;
      padding:0.9rem;
      background:var(--card);
    }
    .profile-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:0.75rem;
    }
    .profile-title{
      font-weight:800;
      font-size:0.95rem;
    }
    .profile-toggle{
      border:1px solid var(--border2);
      background:var(--bubble);
      color:var(--text);
      padding:0.25rem 0.75rem;
      border-radius:999px;
      cursor:pointer;
      font-size:0.85rem;
      font-weight:700;
    }
    .profile-toggle:hover{ border-color: var(--link); }
    .profile-body{ margin-top:0.75rem; }

    .profile-grid{
      display:grid;
      grid-template-columns: 1fr; /* force vertical */
      gap:0.75rem;
    }
    .profile-field label{
      display:block;
      font-size:0.85rem;
      color:var(--muted);
      margin-bottom:0.3rem;
      font-weight:700;
    }
    .profile-field input,
    .profile-field select,
    .profile-field textarea{
      width:100%;
      border-radius:0.75rem;
      border:1px solid var(--border2);
      background:var(--card);
      color:var(--text);
      padding:0.65rem;
      font-size:0.92rem;
    }
    .profile-field textarea{
      min-height: 80px;
      resize:vertical;
    }
    .profile-field input:focus,
    .profile-field select:focus,
    .profile-field textarea:focus{
      outline:none;
      border-color:var(--link);
      box-shadow: 0 0 0 1px var(--link);
    }

    .profile-actions{
      display:flex;
      flex-direction:column;
      align-items:stretch;
      gap:0.5rem;
      margin-top:0.8rem;
    }
    .profile-btn{
      border:none;
      border-radius:999px;
      padding:0.55rem 1rem;
      cursor:pointer;
      font-weight:800;
      color:white;
      background: linear-gradient(135deg, #0ea5e9, #22c55e);
      font-size:0.9rem;
    }
    .profile-btn.secondary{
      background: var(--bubble);
      border:1px solid var(--border2);
      color:var(--text);
    }
    .profile-status{
      font-size:0.85rem;
      color:var(--muted);
      margin-top:0.15rem;
    }

    /* Mode row */
    .mode-row{
      display:flex;
      align-items:center;
      gap:0.75rem;
      margin-top: 0.75rem;
      margin-bottom: 0.5rem;
    }
    .mode-label{
      font-weight:800;
      font-size:0.9rem;
      color:var(--text);
      white-space:nowrap;
    }
    .mode-select{
      width:100%;
      border-radius:0.75rem;
      border:1px solid var(--border2);
      background:var(--card);
      color:var(--text);
      padding:0.6rem;
      font-size:0.92rem;
    }
    .mode-select:focus{
      outline:none;
      border-color:var(--link);
      box-shadow: 0 0 0 1px var(--link);
    }

    /* Question input */
    label[for="question"]{
      display:block;
      font-size:0.9rem;
      font-weight:800;
      margin: 0.9rem 0 0.45rem;
      color: var(--text);
    }
    textarea#question{
      width:100%;
      min-height: 90px;
      border-radius:0.75rem;
      border:1px solid var(--border2);
      background:var(--card);
      color:var(--text);
      padding:0.75rem;
      font-size:0.95rem;
      resize:vertical;
    }
    textarea#question:focus{
      outline:none;
      border-color:var(--link);
      box-shadow: 0 0 0 1px var(--link);
    }

    /* Controls */
    .controls{
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:0.75rem;
      margin-top:0.75rem;
    }
    .status{
      margin-right:auto;
      font-size:0.85rem;
      color:var(--muted);
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:0.55rem 1.2rem;
      cursor:pointer;
      font-weight:800;
      font-size:0.95rem;
      color:white;
      background: linear-gradient(135deg, #0ea5e9, #22c55e);
    }
    .btn.secondary{
      background: var(--bubble);
      border:1px solid var(--border2);
      color:var(--text);
    }
    .btn:disabled{ opacity:0.6; cursor:default; }

    /* Chat */
    .chat{
      margin-top:1.25rem;
      max-height: 520px;
      overflow-y:auto;
      padding-right:0.5rem;
      border-top:1px solid var(--border);
      padding-top:1rem;
    }
    .msg{ margin-bottom: 1rem; }
    .msg-role{
      font-weight:900;
      margin-bottom: 0.25rem;
      color: var(--text);
    }
    .msg-bubble{
      background: var(--bubble);
      border: 1px solid var(--border);
      border-radius: 0.9rem;
      padding: 0.85rem;
      color:#d1d5db;
      white-space: pre-wrap;
      line-height: 1.5;
    }
    .msg-bubble.user{ background: var(--panel); }

    .sources-toggle{
      margin-top:0.5rem;
      display:inline-block;
      font-size:0.85rem;
      color: var(--link);
      cursor:pointer;
      user-select:none;
      font-weight:700;
    }
    .sources-toggle:hover{ text-decoration: underline; }

    .sources{
      margin-top:0.6rem;
      font-size:0.85rem;
      color: var(--muted);
    }
    .sources a{
      color: var(--link);
      text-decoration:none;
    }
    .sources a:hover{ text-decoration: underline; }

    /* Footer */
    .footer{
      margin-top:1.25rem;
      font-size:0.78rem;
      color:#6b7280;
      line-height:1.45;
    }
    .footer strong{ color: var(--text); }

    /* Utilities */
    .hidden{ display:none; }

    @media (max-width: 720px){
      .container{ padding:1rem; }
      .card{ padding:1.2rem; }
      .title{ font-size:1.75rem; }
      .controls{ flex-wrap: wrap; }
      .status{ width:100%; margin-right:0; }
      .btn{ width:100%; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="card">

      <div class="hero">
        <h1 class="title">VAC Policy Assistant</h1>
        <div class="subtitle">
          Navigating Veterans Affairs Canada can be confusing. This independent tool helps Veterans understand policies and programs more easily.
        </div>

        <button id="aboutToggle" type="button" class="about-toggle" aria-expanded="false">
          What this tool can and can’t do <span class="chev" aria-hidden="true">▾</span>
        </button>

        <div id="aboutPanel" class="about-panel hidden" role="region" aria-label="About this tool">
          <div class="about-grid">
            <div class="about-box">
              <div class="about-h">What it can do</div>
              <ul class="about-list">
                <li>Explain VAC policy language in plain terms.</li>
                <li>Show sources used to answer.</li>
                <li>Suggest programs that <em>may</em> be relevant (no guarantees).</li>
                <li>Ask clarifying questions when information is missing.</li>
              </ul>
            </div>

            <div class="about-box">
              <div class="about-h">What it can’t do</div>
              <ul class="about-list">
                <li>Confirm eligibility, approval, or benefit amounts.</li>
                <li>Replace VAC decisions or advice from a qualified representative.</li>
                <li>Guarantee accuracy (policies can change; context may be incomplete).</li>
                <li>Provide legal advice.</li>
              </ul>
            </div>
          </div>

          <div class="about-note">
            <strong>Reminder:</strong> Always confirm details with VAC or a qualified representative.
          </div>
        </div>
      </div>

      <!-- Profile -->
      <div class="profile-card">
        <div class="profile-header">
          <div class="profile-title">Veteran Profile (optional)</div>
          <button id="profileToggle" type="button" class="profile-toggle">Show</button>
        </div>

        <div id="profileBody" class="profile-body hidden">
          <div class="profile-grid">
            <div class="profile-field">
              <label for="pf_service_status">Service status</label>
              <select id="pf_service_status">
                <option value="">(Select)</option>
                <option value="still_serving">Still serving</option>
                <option value="released">Released</option>
                <option value="transitioning">Transitioning</option>
                <option value="family_caregiver">Family / caregiver</option>
              </select>
            </div>

            <div class="profile-field">
              <label for="pf_component">Component</label>
              <select id="pf_component">
                <option value="">(Select)</option>
                <option value="regular_force">Regular Force</option>
                <option value="primary_reserve">Primary Reserve</option>
                <option value="supplementary_reserve">Supplementary Reserve</option>
                <option value="ranger">Canadian Rangers</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div class="profile-field">
              <label for="pf_region">Region (optional)</label>
              <input id="pf_region" placeholder="e.g., Nova Scotia" />
            </div>

            <div class="profile-field">
              <label for="pf_goal">Primary goal (optional)</label>
              <select id="pf_goal">
                <option value="">(Select)</option>
                <option value="rehabilitation">Rehabilitation</option>
                <option value="income_support">Income support</option>
                <option value="health_treatment">Health / treatment</option>
                <option value="family_support">Family support</option>
                <option value="housing_home_support">Home supports</option>
                <option value="education_training">Education / training</option>
                <option value="appeals_help">Appeals / reviews</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div class="profile-field">
              <label for="pf_notes">Notes (optional)</label>
              <textarea id="pf_notes" placeholder="e.g., chronic pain, mobility issues, mental health concerns, current work status"></textarea>
            </div>
          </div>

          <div class="profile-actions">
            <button id="profileSave" type="button" class="profile-btn">Save profile</button>
            <button id="profileClear" type="button" class="profile-btn secondary">Clear profile</button>
            <div id="profileStatus" class="profile-status"></div>
          </div>
        </div>
      </div>

      <!-- Mode -->
      <div class="mode-row">
        <div class="mode-label">Mode</div>
        <select id="mode" class="mode-select">
          <option value="explain" selected>Explain a policy</option>
          <option value="recommend">Suggest benefits that might apply</option>
        </select>
      </div>

      <!-- Question -->
      <label for="question">Your question</label>
      <textarea id="question" placeholder="e.g., What benefits could I apply for?"></textarea>

      <div class="controls">
        <div class="status" id="status"></div>
        <button id="clearButton" type="button" class="btn secondary">Clear chat</button>
        <button id="askButton" type="button" class="btn">Ask</button>
      </div>

      <!-- Chat -->
      <div id="chat" class="chat"></div>

      <div class="footer">
        <strong>Note:</strong> This tool explains VAC policies in plain language using AI and may not always be accurate.
        Always confirm details with
        <a href="https://www.veterans.gc.ca" target="_blank" rel="noopener noreferrer" style="color:var(--link);">Veterans Affairs Canada</a>
        or a qualified representative.
      </div>

    </div>
  </div>

  <script>
    // =============================
    // Config
    // =============================
    const API_URL = "http://127.0.0.1:8000/ask";

    // =============================
    // DOM elements
    // =============================
    const questionEl = document.getElementById("question");
    const askButton = document.getElementById("askButton");
    const clearButton = document.getElementById("clearButton");
    const statusEl = document.getElementById("status");
    const chatEl = document.getElementById("chat");

    const modeEl = document.getElementById("mode");

    const aboutToggle = document.getElementById("aboutToggle");
    const aboutPanel = document.getElementById("aboutPanel");

    const profileToggle = document.getElementById("profileToggle");
    const profileBody = document.getElementById("profileBody");
    const profileSave = document.getElementById("profileSave");
    const profileClear = document.getElementById("profileClear");
    const profileStatus = document.getElementById("profileStatus");

    const pf_service_status = document.getElementById("pf_service_status");
    const pf_component = document.getElementById("pf_component");
    const pf_region = document.getElementById("pf_region");
    const pf_goal = document.getElementById("pf_goal");
    const pf_notes = document.getElementById("pf_notes");

    // =============================
    // Persistence
    // =============================
    const CHAT_KEY = "vac_chat_history_v1";
    const PROFILE_KEY = "vac_veteran_profile_v1";

    let history = [];           // [{question, answer, sources, mode}]
    let veteranProfile = {};    // {service_status, component, region, goal, notes}

    function loadHistory() {
      try {
        const raw = localStorage.getItem(CHAT_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) history = parsed;
      } catch (e) {
        console.warn("Failed to load chat history:", e);
      }
    }

    function saveHistory() {
      try {
        localStorage.setItem(CHAT_KEY, JSON.stringify(history));
      } catch (e) {
        console.warn("Failed to save chat history:", e);
      }
    }

    function loadProfile() {
      try {
        const raw = localStorage.getItem(PROFILE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === "object") veteranProfile = parsed;
      } catch (e) {
        console.warn("Failed to load profile:", e);
      }
    }

    function saveProfile(profile) {
      veteranProfile = profile || {};
      try {
        localStorage.setItem(PROFILE_KEY, JSON.stringify(veteranProfile));
      } catch (e) {
        console.warn("Failed to save profile:", e);
      }
    }

    function clearProfile() {
      veteranProfile = {};
      try {
        localStorage.removeItem(PROFILE_KEY);
      } catch (e) {}
    }

    // =============================
    // Utilities
    // =============================
    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function sourcesToHtml(sources) {
      if (!sources || sources.length === 0) return "<strong>Sources:</strong> None";

      const lines = sources.map((src) => {
        const title = src.title || "Unknown policy";
        const section = src.section ? ` — ${escapeHtml(src.section)}` : "";
        const eff = src.effective_date ? ` (Effective: ${escapeHtml(src.effective_date)})` : "";

        if (src.url) {
          const safeUrl = escapeHtml(src.url);
          return `• <a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${escapeHtml(title)}</a>${section}${eff}`;
        }
        return `• ${escapeHtml(title)}${section}${eff}`;
      });

      return `<strong>Sources:</strong><br>${lines.join("<br>")}`;
    }

    // =============================
    // Render chat
    // =============================
    function renderChat() {
      if (!chatEl) return;

      chatEl.innerHTML = "";

      for (const [i, turn] of history.entries()) {
        // User message
        const userMsg = document.createElement("div");
        userMsg.className = "msg";
        userMsg.innerHTML = `
          <div class="msg-role">You</div>
          <div class="msg-bubble user">${escapeHtml(turn.question)}</div>
        `;
        chatEl.appendChild(userMsg);

        // Assistant message
        const asstMsg = document.createElement("div");
        asstMsg.className = "msg";

        const sourcesId = `sources-${i}`;
        const toggleId = `toggle-${i}`;

        asstMsg.innerHTML = `
          <div class="msg-role">Assistant</div>
          <div class="msg-bubble">${escapeHtml(turn.answer)}</div>
          <div class="sources-toggle" id="${toggleId}">Show sources</div>
          <div class="sources hidden" id="${sourcesId}">
            ${sourcesToHtml(turn.sources)}
          </div>
        `;
        chatEl.appendChild(asstMsg);

        // Toggle handler
        const toggleEl = document.getElementById(toggleId);
        const sourcesEl = document.getElementById(sourcesId);
        if (toggleEl && sourcesEl) {
          toggleEl.addEventListener("click", () => {
            const hidden = sourcesEl.classList.contains("hidden");
            sourcesEl.classList.toggle("hidden");
            toggleEl.textContent = hidden ? "Hide sources" : "Show sources";
          });
        }
      }

      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // =============================
    // Profile UI
    // =============================
    function applyProfileToForm() {
      pf_service_status.value = veteranProfile.service_status || "";
      pf_component.value = veteranProfile.component || "";
      pf_region.value = veteranProfile.region || "";
      pf_goal.value = veteranProfile.goal || "";
      pf_notes.value = veteranProfile.notes || "";
    }

    function readProfileFromForm() {
      return {
        service_status: pf_service_status.value || "",
        component: pf_component.value || "",
        region: pf_region.value.trim() || "",
        goal: pf_goal.value || "",
        notes: pf_notes.value.trim() || ""
      };
    }

    // =============================
    // Main ask function
    // =============================
    async function askQuestion() {
      const question = questionEl.value.trim();
      if (!question) {
        statusEl.textContent = "Please enter a question.";
        return;
      }

      askButton.disabled = true;
      statusEl.textContent = "Thinking...";

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            question,
            mode: modeEl ? modeEl.value : "explain",
            profile: veteranProfile || {}
          }),
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(`Server error ${res.status}: ${text}`);
        }

        const data = await res.json();

        history.push({
          question,
          answer: data.answer || "No answer returned.",
          sources: data.sources || [],
          mode: modeEl ? modeEl.value : "explain",
        });

        saveHistory();
        renderChat();

        statusEl.textContent = "Done.";
        questionEl.value = "";
        questionEl.focus();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Something went wrong. Make sure the API (server.py) is running on port 8000 and your OPENAI_API_KEY is set.";
      } finally {
        askButton.disabled = false;
      }
    }

    // =============================
    // Wire up events
    // =============================
    askButton.addEventListener("click", askQuestion);

    questionEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
        askQuestion();
      }
    });

    clearButton.addEventListener("click", () => {
      history = [];
      saveHistory();
      renderChat();
      statusEl.textContent = "Chat cleared.";
    });

    // About toggle
    if (aboutToggle && aboutPanel) {
      aboutToggle.addEventListener("click", () => {
        const isHidden = aboutPanel.classList.contains("hidden");
        aboutPanel.classList.toggle("hidden");
        aboutToggle.setAttribute("aria-expanded", String(isHidden));
        const chev = aboutToggle.querySelector(".chev");
        if (chev) chev.textContent = isHidden ? "▴" : "▾";
      });
    }

    // Profile toggle
    if (profileToggle && profileBody) {
      profileToggle.addEventListener("click", () => {
        const isHidden = profileBody.classList.contains("hidden");
        profileBody.classList.toggle("hidden");
        profileToggle.textContent = isHidden ? "Hide" : "Show";
      });
    }

    profileSave.addEventListener("click", () => {
      const profile = readProfileFromForm();
      saveProfile(profile);
      profileStatus.textContent = "Profile saved.";
      setTimeout(() => (profileStatus.textContent = ""), 1500);
    });

    profileClear.addEventListener("click", () => {
      clearProfile();
      applyProfileToForm();
      profileStatus.textContent = "Profile cleared.";
      setTimeout(() => (profileStatus.textContent = ""), 1500);
    });

    // =============================
    // Initial load
    // =============================
    loadProfile();
    applyProfileToForm();

    loadHistory();
    renderChat();
  </script>
</body>
</html>
